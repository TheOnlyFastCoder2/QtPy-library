## üìö –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞](#-—Å–æ–∑–¥–∞–Ω–∏–µ-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞)
2. [üì¢ subscribe](#-subscribe)
3. [üéØ subscribeToPath](#-subscribetopath)
4. [‚úèÔ∏è update](#Ô∏è-update)
5. [üîç get](#-get)
6. [‚ôªÔ∏è invalidate](#-invalidate)
7. [‚è≥ asyncUpdate](#-asyncupdate)
8. [üì¶ batch](#-batch)
9. [‚Ü©Ô∏è undo / ‚Ü™Ô∏è redo](#Ô∏è-undo--Ô∏è-redo)
10. [üõ£Ô∏è resolvePath](#Ô∏è-resolvepath)
11. [üßπ manualCleanup](#-manualcleanup)
12. [üìä getMemoryStats](#-getmemorystats)
13. [üóëÔ∏è clearStore](#-clearstore)
14. [üõ† Middleware](#-Middleware)
15. [üè∑Ô∏è state / üõ†Ô∏è `$`](#Ô∏è-state--Ô∏è-)
16. [üöÄ –ì–∞–π–¥: asyncUpdate –∏ batch –≤ ObservableStore](#-–ì–∞–π–¥-asyncUpdate-–∏-batch-–≤-ObservableStore)
17. [üîó –û–±—â–∏–π –ø—Ä–∏–º–µ—Ä](#-–æ–±—â–∏–π-–ø—Ä–∏–º–µ—Ä)

---

## üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

> **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏, –∫–µ—à-–∫–ª—é—á–∞–º–∏, –∏—Å—Ç–æ—Ä–∏–µ–π –∏ –±–∞—Ç—á–∏–Ω–≥–æ–º.

### ‚öôÔ∏è –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```ts
function createObservableStore<T extends object>(
  initialState: T,
  middlewares?: Middleware<T>[],
  options?: {
    maxHistoryLength?: number;
  }
): ObservableStore<T>;
```

### üìù –û–ø–∏—Å–∞–Ω–∏–µ

- **state** —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ (–ø—Ä—è–º–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç).
- **–ü–æ–¥–ø–∏—Å–∫–∏** –Ω–∞ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø—É—Ç—è–º.
- **CacheKey** –¥–ª—è –≤—ã–±–æ—Ä–æ—á–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
- **–ò—Å—Ç–æ—Ä–∏—è** —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ `undo`/`redo`.
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ** –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –æ—Ç–º–µ–Ω—ã.
- **Batching** –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ –æ–¥–∏–Ω —Ü–∏–∫–ª –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–π.
- **–ê–≤—Ç–æ-–æ—á–∏—Å—Ç–∫–∞** –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏.

### üì• –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ò–º—è                   | –¢–∏–ø               | –û–ø–∏—Å–∞–Ω–∏–µ                               |
| --------------------- | ----------------- | -------------------------------------- |
| `initialState`        | `T`               | –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ª—é–±–æ–π –æ–±—ä–µ–∫—Ç).    |
| `middlewares?`        | `Middleware<T>[]` | –ú–∞—Å—Å–∏–≤ —Ñ—É–Ω–∫—Ü–∏–π-–ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–æ–≤ `update`. |
| `options?`            | `{‚Ä¶}`             | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:              |
| ‚îî `maxHistoryLength?` | `number`          | –ú–∞–∫—Å. —á–∏—Å–ª–æ –∑–∞–ø–∏—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞ –ø—É—Ç—å.   |

### ‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä

```ts
const store = createObservableStore<{ counter: number }>(
  { counter: 0 },
  [loggerMiddleware],
  { maxHistoryLength: 50, cleanupInterval: 60000 }
);
```

---

## üì¢ subscribe

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –°–ª—É—à–∞—Ç—å **–≤—Å–µ** –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è.

### ‚öôÔ∏è –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```ts
subscribe(
  callback: Subscriber<T>,
  cacheKeys?: CacheKey<T>[]
): Unsubscribe;
```

### üìù –û–ø–∏—Å–∞–Ω–∏–µ

- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –ª—é–±–æ–º `update` (–∏–ª–∏ –ø—Ä—è–º–æ–º `state`-–ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–∏).
- –ú–æ–∂–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –º–∞—Å—Å–∏–≤—É `cacheKeys`.

### üì• –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ò–º—è          | –¢–∏–ø                  | –û–ø–∏—Å–∞–Ω–∏–µ                                          |
| ------------ | -------------------- | ------------------------------------------------- |
| `callback`   | `(state: T) => void` | –§—É–Ω–∫—Ü–∏—è, –ø–æ–ª—É—á–∞—é—â–∞—è –Ω–æ–≤—ã–π —Å–Ω–∏–º–æ–∫ –≤—Å–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è. |
| `cacheKeys?` | `CacheKey<T>[]`      | –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π/–ø—É—Ç–µ–π –¥–ª—è —Å–µ–ª–µ–∫—Ç–∏–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.  |

### ‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä

```ts
const unsubscribe = store.subscribe(
  (s) => console.log("–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:", s),
  [store.$.user.name, "customKey"]
);
```

---

## üéØ subscribeToPath

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ **–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ** –ø–æ–ª—è.

### ‚öôÔ∏è –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```ts
subscribeToPath<P extends PathTracker<any, any>>(
  path: P,
  callback: Subscriber<P>,
  options?: {
    immediate?: boolean;
    cacheKeys?: CacheKey<T>[];
  }
): Unsubscribe;
```

### üìù –û–ø–∏—Å–∞–Ω–∏–µ

- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ `path`.
- –û–ø—Ü–∏—è `immediate` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∫–æ–ª–±—ç–∫ —Å—Ä–∞–∑—É —Å —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º.

### üì• –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ò–º—è        | –¢–∏–ø                                               | –û–ø–∏—Å–∞–Ω–∏–µ                                             |
| ---------- | ------------------------------------------------- | ---------------------------------------------------- |
| `path`     | `PathTracker<any, any>`                           | –¢—Ä–µ–∫–µ—Ä –ø—É—Ç–∏ (—á–µ—Ä–µ–∑ `store.$`).                       |
| `callback` | `(value: P[TYPE_SYMBOL]) => void`                 | –§—É–Ω–∫—Ü–∏—è, –ø–æ–ª—É—á–∞—é—â–∞—è –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –ø—É—Ç–∏.          |
| `options?` | `{ immediate?: boolean; cacheKeys?: CacheKey[] }` | `immediate`: —Å—Ä–∞–∑—É; `cacheKeys`: —Ñ–∏–ª—å—Ç—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. |

### ‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä

```ts
store.subscribeToPath(
  store.$.user.age,
  (age) => console.log("–ù–æ–≤—ã–π –≤–æ–∑—Ä–∞—Å—Ç:", age),
  { immediate: true }
);
```

---

## ‚úèÔ∏è update

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –ò–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –ø—É—Ç–∏.

### ‚öôÔ∏è –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```ts
update<P extends PathTracker<any, any>>(
  path: P,
  value:
    | P[typeof TYPE_SYMBOL]
    | ((cur: P[typeof TYPE_SYMBOL]) => P[typeof TYPE_SYMBOL])
): void;
```

### üìù –û–ø–∏—Å–∞–Ω–∏–µ

- –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é-–æ–±–Ω–æ–≤–∏—Ç–µ–ª—å.
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é.

### üì• –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ò–º—è     | –¢–∏–ø                                         | –û–ø–∏—Å–∞–Ω–∏–µ                         |
| ------- | ------------------------------------------- | -------------------------------- |
| `path`  | `PathTracker<any, any>`                     | –¢—Ä–µ–∫–µ—Ä –ø—É—Ç–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—è. |
| `value` | `NewValue` –∏–ª–∏ `(cur: Current) => NewValue` | –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è.      |

### ‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä

```ts
store.update(store.$.counter, (c) => c + 1);
store.update(store.$.user.name, "Alice");
```

---

## üîç get

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –ø—É—Ç–∏.

### ‚öôÔ∏è –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```ts
get<P extends PathTracker<any, any>>(
  path: P
): P[typeof TYPE_SYMBOL] | undefined;
```

### üìù –û–ø–∏—Å–∞–Ω–∏–µ

- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∏–ª–∏ `undefined`, –µ—Å–ª–∏ –Ω–µ—Ç.

### ‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä

```ts
const email = store.get(store.$.user.contacts.email);
console.log("Email:", email);
```

---

## ‚ôªÔ∏è invalidate

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –§–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ —É–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –ø–æ –∫–µ—à-–∫–ª—é—á—É.

### ‚öôÔ∏è –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```ts
invalidate(
  cacheKey: CacheKey<T>,
): void;
```

### üìù –û–ø–∏—Å–∞–Ω–∏–µ

- –ü–æ–≤—Ç–æ—Ä–Ω–æ ‚Äú–¥–µ—Ä–≥–∞–µ—Ç‚Äù –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–ª—é—á–∞.

### ‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä

```ts
store.invalidate(store.$.user.contacts.email);
store.invalidate("customCacheKeyEmail", true);
```

---

## ‚è≥ asyncUpdate

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ—Ç–º–µ–Ω–æ–π ¬´—É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö¬ª –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–æ–≤—ã–µ –≤—ã–∑–æ–≤—ã **–Ω–µ** –æ—Ç–º–µ–Ω—è—é—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ, –Ω–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å `options.abortPrevious = true`, —Ç–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –±—É–¥–µ—Ç –ø—Ä–µ—Ä–≤–∞–Ω —á–µ—Ä–µ–∑ `AbortController`.

### ‚öôÔ∏è –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```ts
asyncUpdate<P extends PathTracker<any, any>>(
  path: P,
  asyncUpdater: (
    cur: P[typeof TYPE_SYMBOL],
    signal: AbortSignal
  ) => Promise<P[typeof TYPE_SYMBOL]>,
  options?: {
    /**
     * –ï—Å–ª–∏ `true`, —Ç–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —ç—Ç–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
     * –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω—ë–Ω (abort) –ª—é–±–æ–π –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–∏–≤—à–∏–π—Å—è
     * –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ç–æ–º –∂–µ `path`.
     * –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî `false`.
     */
    abortPrevious?: boolean
  }
): Promise<void>;
```

### üìù –û–ø–∏—Å–∞–Ω–∏–µ

- –ü–µ—Ä–µ–¥–∞—ë—Ç –≤ `asyncUpdater` —Ç–µ–∫—É—â–∏–π `cur` –∏ `AbortSignal` –¥–ª—è –æ—Ç–º–µ–Ω—ã.
- **`options.abortPrevious`** = `true` –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ —Ç–æ–º—É –∂–µ –ø—É—Ç–∏; –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî `false`, –≤—Å–µ –≤—ã–∑–æ–≤—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–æ –∫–æ–Ω—Ü–∞.

### ‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä

```ts
// –û–¥–∏–Ω –≤—ã–∑–æ–≤ asyncUpdate –±–µ–∑ –æ—Ç–º–µ–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
await store.asyncUpdate(
  store.$.user.age,
  async (currentAge, signal) => fetchAgeFromApi(signal),
  { abortPrevious: true }
);
```

---

## üì¶ batch

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –æ–¥–Ω—É –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é.

### ‚öôÔ∏è –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```ts
batch(
  callback: () => void,
): void;
```

### üìù –û–ø–∏—Å–∞–Ω–∏–µ

- –í—Å–µ `update` –∏ `asyncUpdate` –≤–Ω—É—Ç—Ä–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

### ‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä

```ts
store.batch(async () => {
  store.update(store.$.counter, 5);
  await store.asyncUpdate(store.$.user.age, async (a) => a * 2);
});
```

---

## ‚Ü©Ô∏è undo / ‚Ü™Ô∏è redo

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –û—Ç–º–µ–Ω–∏—Ç—å –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ –ø—É—Ç–∏.

### ‚öôÔ∏è –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```ts
undo(path: PathTracker<any, any>): void;
redo(path: PathTracker<any, any>): void;
```

### üìù –û–ø–∏—Å–∞–Ω–∏–µ

- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è.
- `undo` ‚Üí –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª–æ–π, `redo` ‚Üí –æ–±—Ä–∞—Ç–Ω–æ.

### ‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä

```ts
const $StoreAge = store.$.user.age; // –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
store.update($StoreAge, 40);
store.undo($StoreAge); // –≤–µ—Ä–Ω—É–ª–∏—Å—å –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
store.redo($StoreAge); // 40
```

---

## üõ£Ô∏è resolvePath

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫—É –ø—É—Ç–∏ –≤ ‚Äúdot.notation‚Äù.

### ‚öôÔ∏è –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```ts
resolvePath(
  proxyPath: PathTracker<any, any> | string
): string;
```

### üìù –û–ø–∏—Å–∞–Ω–∏–µ

- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ç—Ä–µ–∫–µ—Ä –∏–ª–∏ —Å—Ç—Ä–æ–∫—É –≤ `"user.name"` –∏ —Ç. –¥.

### ‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä

```ts
console.log(store.resolvePath(store.$.user.name)); // "user.name"
```

---

## üßπ manualCleanup

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –£–¥–∞–ª–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ø—É—Ç–µ–π –±–µ–∑ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.

```ts
manualCleanup(): void;
```

---

## üìä getMemoryStats

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: –ø–æ–¥–ø–∏—Å—á–∏–∫–∏, –∏—Å—Ç–æ—Ä–∏—è, –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—É—Ç–∏.

```ts
getMemoryStats(): MemoryStats;
```

---

## üóëÔ∏è clearStore

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ: –ø–æ–¥–ø–∏—Å–∫–∏, async-–∑–∞–¥–∞—á–∏, –∫–µ—à.

```ts
clearStore(): void;
```

## üõ† Middleware

> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
> –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å, –¥–æ–ø–æ–ª–Ω—è—Ç—å –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã–∑–æ–≤—ã `store.update` (–∏, –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏, `asyncUpdate`), –≤—ã–ø–æ–ª–Ω—è—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.

### ‚öôÔ∏è –°–∏–≥–Ω–∞—Ç—É—Ä–∞

```ts
export type Middleware<T> = (
  store: ObservableStore<T>,
  next: UpdateFunction<T>
) => (path: any, value: any) => void;
```

- **`store`** ‚Äî —ç–∫–∑–µ–º–ø–ª—è—Ä –≤–∞—à–µ–≥–æ `ObservableStore`, –¥–∞—é—â–∏–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –º–µ—Ç–æ–¥–∞–º (`update`, `asyncUpdate`, `batch` –∏ —Ç.–¥.).
- **`next`** ‚Äî ¬´—Å–ª–µ–¥—É—é—â–∏–π¬ª –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: –ª–∏–±–æ —Å–ª–µ–¥—É—é—â–∏–π middleware –≤ —Ü–µ–ø–æ—á–∫–µ, –ª–∏–±–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π `store.update`.
- Middleware –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å —Ç–æ–π –∂–µ —Å–∏–≥–Ω–∞—Ç—É—Ä–æ–π, –≥–¥–µ –≤—ã –º–æ–∂–µ—Ç–µ:

  - –≤—ã–∑–≤–∞—Ç—å `next(path, value)` –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–ª—å—à–µ;
  - –∏–∑–º–µ–Ω–∏—Ç—å `path` –∏–ª–∏ `value` –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π;
  - –≤–æ–æ–±—â–µ **–Ω–µ** –≤—ã–∑—ã–≤–∞—Ç—å `next` ‚Äî —á—Ç–æ–±—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ.

---

### ‚ñ∂Ô∏è –ü—Ä–∏–º–µ—Ä: —Ç—Ä–∏ middleware —Å —É—Å–ª–æ–≤–∏–µ–º –Ω–∞ `next`

```ts
// 1) –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
const logMiddleware: Middleware<MyState> = (store, next) => (path, value) => {
  console.log("[LOG]", store.resolvePath(path), "‚Üí", value);
  next(path, value);
};

// 2) –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞
const blockNegativeAge: Middleware<MyState> =
  (store, next) => (path, value) => {
    if (
      store.resolvePath(path) === "user.age" &&
      typeof value === "number" &&
      value < 0
    ) {
      console.warn("[BLOCKED] –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç:", value);
      return; // –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º next ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è
    }
    next(path, value);
  };

// 3) –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä
const uppercaseTitle: Middleware<MyState> = (store, next) => (path, value) => {
  if (store.resolvePath(path) === "post.title" && typeof value === "string") {
    next(path, value.toUpperCase());
  } else {
    next(path, value);
  }
};

// –°–æ–∑–¥–∞–µ–º —Å—Ç–æ—Ä —Å —Ç—Ä–µ–º—è middleware
const store = createObservableStore<MyState>(initialState, [
  logMiddleware,
  blockNegativeAge,
  uppercaseTitle,
]);

// –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è:
store.update(store.$.user.age, -5); // [BLOCKED] –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç: -5
store.update(store.$.user.age, 30); // [LOG] user.age ‚Üí 30

store.update(store.$.post.title, "hello world");
// [LOG] post.title ‚Üí HELLO WORLD
```

---

## üè∑Ô∏è state / üõ†Ô∏è `$`

| –°–≤–æ–π—Å—Ç–≤–æ | –¢–∏–ø            | –û–ø–∏—Å–∞–Ω–∏–µ                                         |
| -------- | -------------- | ------------------------------------------------ |
| `state`  | `T`            | –ü—Ä–æ–∫—Å–∏-–æ–±—ä–µ–∫—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –ø—Ä—è–º–æ–≥–æ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏—è. |
| `$`      | `PathProxy<T>` | –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä ‚Äúpath trackers‚Äù –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫ –∏ update. |

---

# üöÄ –ì–∞–π–¥: `asyncUpdate` –∏ `batch` –≤ `ObservableStore`

–í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏:

- **`store.batch(fn)`** ‚Äî –µ–¥–∏–Ω—ã–π —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –±–∞—Ç—á —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ —Å—Ç–µ–∫ `pendingStack`.
- **`store.asyncUpdate(path, updater, { abortPrevious = false })`** ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é **–Ω–µ –æ—Ç–º–µ–Ω—è–µ—Ç** –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å –æ—Ç–º–µ–Ω—É.

---

## ‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ API

- **üîß `store.update(path, value)`**  
  –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –º–µ–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ `path`. –ï—Å–ª–∏ –≤—ã –≤–Ω—É—Ç—Ä–∏ `store.batch`, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç; –∏–Ω–∞—á–µ —Å—Ä–∞–∑—É –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ `doUpdate` (–∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤).

- **üì¶ `store.batch(fn: () => void)`**  
  –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç **—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ** –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –æ–¥–∏–Ω –∞—Ç–æ–º–∞—Ä–Ω—ã–π –∫–æ–º–º–∏—Ç.

  - –ö–∞–∂–¥–æ–º—É –≤—ã–∑–æ–≤—É —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–≤–æ–π `Map<string, any>` –≤ `pendingStack`.
  - –í–ª–æ–∂–µ–Ω–Ω—ã–µ `store.batch` –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.
  - –ü–æ –≤—ã—Ö–æ–¥—É –∏–∑ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–∞—Ç—á–∞ –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –æ–¥–Ω–∏–º –ø–∞–∫–µ—Ç–æ–º.

- \*\*‚è≥ `store.asyncUpdate(`  
  &nbsp;&nbsp;`path, updater: (cur, signal) => Promise<any>,`  
  &nbsp;&nbsp;`opts?: { abortPrevious?: boolean }`  
  `)`  
  –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∞–ø–¥–µ–π—Ç –ø–æ `path`.
  - **`opts.abortPrevious = false`** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ‚Äî –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤—ã–∑–æ–≤—ã **–Ω–µ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è**, –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏.
  - **`opts.abortPrevious = true`** ‚Äî –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π **–ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è** —á–µ—Ä–µ–∑ `AbortController`, –∏ –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–ø–∏—à–µ—Ç—Å—è –≤ —Å—Ç–æ—Ä.

---

## ‚ö° –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `batch`

1. –í—Ö–æ–¥ –≤ `store.batch(fn)`:
   - `pendingStack.push(new Map())`, `batching = true`.
2. –í —Ç–µ–ª–µ `fn()` –≤—Å–µ `store.update(...)` –∏ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è —á–µ—Ä–µ–∑ `store.state.* = ...` –æ—Ç–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –≤ –≤–µ—Ä—Ö–Ω–∏–π `Map`.
3. –í—ã—Ö–æ–¥ –∏–∑ bat—Åh:
   - –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π `Map` (–≤–ª–æ–∂–µ–Ω–Ω—ã–π –±–∞—Ç—á), –ø—Ä–æ—Å—Ç–æ —Å–ª–∏–≤–∞–µ–º –¥–æ—á–µ—Ä–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–æ–¥–∏—Ç–µ–ª—è.
   - –ò–Ω–∞—á–µ (–≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å) –≤—ã–∑—ã–≤–∞–µ–º `commit(pending)`:
     - –î–ª—è –∫–∞–∂–¥–æ–π –ø–∞—Ä—ã `[path, val]` ‚Äî –ø—É—à–∏–º –≤ –∏—Å—Ç–æ—Ä–∏—é, –ø–∏—à–µ–º –≤ `rawState` –∏ –Ω–æ—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.
   - –°–±—Ä–∞—Å—ã–≤–∞–µ–º `batching = false`.

---

## üíª –ü—Ä–∏–º–µ—Ä 1: –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –±–∞—Ç—á–∏

```ts
// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è count
store.subscribeToPath(store.$.count, (v) => console.log("count =", v));

// –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
store.update(store.$.count, 0); // ‚Üí count = 0

// –í–Ω–µ—à–Ω–∏–π –±–∞—Ç—á
store.batch(() => {
  store.update(store.$.count, 5); // –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç1

  store.batch(() => {
    store.state.count = 10; // –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç2
  });
  // –∫–æ–Ω—Ç–µ–∫—Å—Ç2 —Å–ª–∏—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç1

  store.state.count += 1; // —Ç–µ–ø–µ—Ä—å –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç1: 10 + 1 = 11
});
// –ü–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ –≤–µ—Ä—Ö–Ω–µ–≥–æ batch –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è —Å—Ä–∞–∑—É ‚Üí count = 11
```

---

## üíª –ü—Ä–∏–º–µ—Ä 2: `asyncUpdate` –±–µ–∑ –æ—Ç–º–µ–Ω—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

```ts
// –ü–æ–¥–ø–∏—Å–∫–∞
store.subscribeToPath(store.$.count, (v) => console.log("count =", v));

// –°–±—Ä–æ—Å
store.update(store.$.count, 0); // ‚Üí count = 0

// –î–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö asyncUpdate
store.asyncUpdate(
  store.$.count,
  async (v) => new Promise((res) => setTimeout(() => res(v + 10), 1000))
);
store.asyncUpdate(
  store.$.count,
  async (v) => new Promise((res) => setTimeout(() => res(v + 5), 500))
);
// –ß–µ—Ä–µ–∑ ~500 –º—Å: –ø–µ—Ä–≤—ã–π –∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è ‚Äî count = 0 + 5 = 5
// –ß–µ—Ä–µ–∑ ~1000 –º—Å: –¥–ª–∏–Ω–Ω—ã–π —Ç–æ–∂–µ –∑–∞–ø–∏—à–µ—Ç —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —Ç–µ–∫—É—â–µ–º –∑–Ω–∞—á–µ–Ω–∏–∏ 5 ‚Üí count = 15
```

---

## üíª –ü—Ä–∏–º–µ—Ä 3: `asyncUpdate` —Å –æ—Ç–º–µ–Ω–æ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ

```ts
// –°–Ω–æ–≤–∞ —Å–±—Ä–æ—Å
store.update(store.$.count, 0); // ‚Üí count = 0

// –í–∫–ª—é—á–∞–µ–º abortPrevious
store.asyncUpdate(
  store.$.count,
  async (v) => new Promise((res) => setTimeout(() => res(v + 10), 1000))
);
store.asyncUpdate(
  store.$.count,
  async (v) => new Promise((res) => setTimeout(() => res(v + 5), 500)),
  { abortPrevious: true }
);
// –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–π:
// –ß–µ—Ä–µ–∑ ~500 –º—Å: –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è +5 ‚Üí count = 5
// –ü–µ—Ä–≤—ã–π –ø–æ—Å–ª–µ 1 —Å –Ω–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –∏–∑-–∑–∞ abort()
```

---

## üíª –ü—Ä–∏–º–µ—Ä 4: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –±–∞—Ç—á–∞

```ts
store.subscribeToPath(store.$.count, (v) => console.log("count =", v));

// –°–±—Ä–∞—Å—ã–≤–∞–µ–º
store.update(store.$.count, 0); // ‚Üí count = 0

// Batch —Å –¥–≤—É–º—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ asyncUpdate
store.batch(async () => {
  await store.asyncUpdate(
    store.$.count,
    async (v) => new Promise((res) => setTimeout(() => res(v + 10), 1000))
  ); // –ø–æ—Å–ª–µ 1 —Å count = 10

  await store.asyncUpdate(
    store.$.count,
    async (v) => new Promise((res) => setTimeout(() => res(v + 5), 500))
  ); // –µ—â—ë —á–µ—Ä–µ–∑ 0.5 —Å count = 15
});
// –ü–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é batch –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—É–¥–µ—Ç: 10, –∑–∞—Ç–µ–º 15
```

---

## üéâ –ò—Ç–æ–≥–∏

- **–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `batch`** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤–ª–æ–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Å—Ç–µ–∫ ‚Äî –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –∞—Ç–æ–º–∞—Ä–Ω–æ–º –∫–æ–º–º–∏—Ç–µ.
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `asyncUpdate`** —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–ø—Ü–∏–µ–π `abortPrevious`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–π, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –æ—Ç–∫–∞–∑–∞ –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.
- –ì–∏–±–∫–æ—Å—Ç—å –∏ —è–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø–æ—Ä—è–¥–∫–æ–º –∏ –æ—Ç–º–µ–Ω–æ–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–æ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è.
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã (`history`, —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–∫—Å–∏, –ø–æ–¥–ø–∏—Å–∫–∏) —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ.

---

## üíª –ü—Ä–∏–º–µ—Ä 2: `asyncUpdate` –±–µ–∑ –æ—Ç–º–µ–Ω—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

```ts
// –ü–æ–¥–ø–∏—Å–∫–∞
store.subscribeToPath(store.$.count, (v) => console.log("count =", v));

// –°–±—Ä–æ—Å–∏–º
store.update(store.$.count, 0); // ‚Üí count = 0

// –î–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö asyncUpdate
store.asyncUpdate(
  store.$.count,
  async (v) => new Promise((res) => setTimeout(() => res(v + 10), 1000))
);
store.asyncUpdate(
  store.$.count,
  async (v) => new Promise((res) => setTimeout(() => res(v + 5), 500))
);
// –ß–µ—Ä–µ–∑ ~500 –º—Å: –ø–µ—Ä–≤—ã–π –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è ‚Äî count = 0 + 5 = 5
// –ß–µ—Ä–µ–∑ ~1000 –º—Å: –≤—Ç–æ—Ä–æ–π (–¥–æ–ª–≥–∏–π) —Ç–æ–∂–µ –∑–∞–ø–∏—à–µ—Ç —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫ –º–æ–º–µ–Ω—Ç—É –∑–∞–ø—É—Å–∫–∞:
//   –±–µ—Ä—ë—Ç —Ç–µ–∫—É—â–µ–µ (5) + 10 = 15 ‚Üí count = 15
```

---

## üíª –ü—Ä–∏–º–µ—Ä 3: `asyncUpdate` —Å –æ—Ç–º–µ–Ω–æ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ

```ts
// –°–Ω–æ–≤–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
store.update(store.$.count, 0); // ‚Üí count = 0

// –£–∫–∞–∑—ã–≤–∞–µ–º opts.abortPrevious = true
store.asyncUpdate(
  store.$.count,
  async (v) => new Promise((res) => setTimeout(() => res(v + 10), 1000)),
  { abortPrevious: true }
);
store.asyncUpdate(
  store.$.count,
  async (v) => new Promise((res) => setTimeout(() => res(v + 5), 500)),
  { abortPrevious: true }
);
// –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—ã–π:
// –ß–µ—Ä–µ–∑ ~500 –º—Å: —Ç–æ–ª—å–∫–æ +5 –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è ‚Üí count = 5
// –ü–µ—Ä–≤—ã–π –ø–æ—Å–ª–µ 1 —Å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç.–∫. –±—ã–ª abort()
```

---

## üéâ –ò—Ç–æ–≥–∏

- **–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `batch`** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤–ª–æ–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ —Å—Ç–µ–∫ ‚Äî –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –∞—Ç–æ–º–∞—Ä–Ω–æ–º –∫–æ–º–º–∏—Ç–µ.
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `asyncUpdate`** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ –æ—Ç–º–µ–Ω—è–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã, –Ω–æ –æ–ø—Ü–∏—é –æ—Ç–º–µ–Ω—ã –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ `{ abortPrevious: true }`.
- –ì–∏–±–∫–æ—Å—Ç—å –∏ —è–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ç–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å ¬´—É—Å—Ç–∞—Ä–µ–≤—à–∏–µ¬ª –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã—Ö –≥–æ–Ω–æ–∫ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.
- –ò—Å—Ç–æ—Ä–∏—è, `lazy`-–ø—Ä–æ–∫—Å–∏ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–¥ —ç—Ç–∏–º –Ω–æ–≤—ã–º API.

---

## üîó –û–±—â–∏–π –ø—Ä–∏–º–µ—Ä

```ts
// –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
interface AppState {
  counter: number; // –°—á—ë—Ç—á–∏–∫
  user: {
    // –û–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    name: string; // –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    age: number; // –í–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    contacts: {
      // –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      email: string; // Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      phone?: string; // –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω
      lol: {
        // –í–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç LOL
        value: number; // –ó–Ω–∞—á–µ–Ω–∏–µ LOL
      };
    };
  };
}

// –ü–µ—Ä–≤–æ–µ middleware: —É–º–Ω–æ–∂–∞–µ—Ç —Ü–µ–ª—ã–µ —á–∏—Å–ª–∞ –Ω–∞ 2
const middlewareLogger1: Middleware<AppState> =
  (store, next) => (path, value) => {
    if (Number.isInteger(value)) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ü–µ–ª–æ–µ –ª–∏ —á–∏—Å–ª–æ
      next(path, value * 2); // –ü–µ—Ä–µ–¥–∞—ë–º –≤ next –∑–Ω–∞—á–µ–Ω–∏–µ * 2
      return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –¥–∞–ª–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    }
    next(path, value); // –ò–Ω–∞—á–µ –ø–µ—Ä–µ–¥–∞—ë–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  };
// –í—Ç–æ—Ä–æ–µ middleware: –ª–æ–≥–≥–∏—Ä—É–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ (–Ω–µ—á–∏—Å–ª–æ–≤—ã–µ) –∑–Ω–∞—á–µ–Ω–∏—è
const middlewareLogger2: Middleware<AppState> =
  (store, next) => (path, value) => {
    console.log("not numbers", value, store.resolvePath(path)); // –í—ã–≤–æ–¥–∏–º –ø—É—Ç—å –∏ –∑–Ω–∞—á–µ–Ω–∏–µ
    next(path, value); // –ü–µ—Ä–µ–¥–∞—ë–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–∞–ª—å—à–µ
  };

// –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å –Ω–∞—á–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º middleware
const store = createObservableStore<AppState>(
  {
    counter: 0, // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á—ë—Ç—á–∏–∫–∞
    user: {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      name: "John", // –ò–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      age: 30, // –í–æ–∑—Ä–∞—Å—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      contacts: {
        // –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        email: "john@example.com", // Email
        lol: { value: 2 }, // LOL –∑–Ω–∞—á–µ–Ω–∏–µ
      },
    },
  },
  [middlewareLogger1, middlewareLogger2]
);

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
store.subscribeToPath(store.$.user.age, (value) => {
  console.log("updated age:", value); // –õ–æ–≥–≥–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –≤–æ–∑—Ä–∞—Å—Ç
});

const $StoreAge = store.$.user.age; // –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É
store.update($StoreAge, 20); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç –≤ 20
store.undo($StoreAge); // –û—Ç–º–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤–æ–∑–≤—Ä–∞—â–∞–µ–º 30)
store.redo($StoreAge); // –ü–æ–≤—Ç–æ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≤–æ–∑–≤—Ä–∞—â–∞–µ–º 20)

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ email —Å –∫–µ—à-–∫–ª—é—á–æ–º
store.subscribe(
  (newStore) => {
    console.log("changed value email:", store.get(store.$.user.contacts.email)); // –õ–æ–≥–≥–∏—Ä—É–µ–º email
  },
  [store.$.user.contacts.email, "customCacheKeyEmail"] // –ö–µ—à-–∫–ª—é—á–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
);

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
store.subscribe((newStore) => {
  console.log("changed value:", newStore); // –õ–æ–≥–≥–∏—Ä—É–µ–º –≤—Å—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ
});

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –≤–æ–∑—Ä–∞—Å—Ç
store.subscribeToPath(store.$.user.age, (value) => {
  console.log("updated age", value); // –õ–æ–≥–≥–∏—Ä—É–µ–º –≤–æ–∑—Ä–∞—Å—Ç
});

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤–æ–∑—Ä–∞—Å—Ç –∏ –∏–º—è —Å –∫–µ—à-–∫–ª—é—á–∞–º–∏
store.subscribeToPath(
  store.$.user.age, // –ü—É—Ç—å –∫ –≤–æ–∑—Ä–∞—Å—Ç—É
  (value) => {
    console.log("updated age:", value); // –õ–æ–≥–≥–∏—Ä—É–µ–º –≤–æ–∑—Ä–∞—Å—Ç
    console.log("updated name:", store.get(store.$.user.name)); // –õ–æ–≥–≥–∏—Ä—É–µ–º –∏–º—è
  },
  { cacheKeys: [store.$.user.name, "customCacheKeyName"] } // –ö–µ—à-–∫–ª—é—á–∏
);

// –ü—Ä–∏–º–µ—Ä –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ –±–∞—Ç—á–∏–Ω–≥–∞
const test = async () => {
  console.log("invalidate –¥–ª—è email"); // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è email
  await store.invalidate(store.$.user.contacts.email); // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–æ –ø—É—Ç–∏
  await store.invalidate("customCacheKeyEmail"); // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–æ —Å—Ç—Ä–æ–∫–æ–≤–æ–º—É –∫–ª—é—á—É
  console.log("invalidate –¥–ª—è name"); // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏
  await store.invalidate(store.$.user.name); // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–æ –ø—É—Ç–∏
  await store.invalidate("customCacheKeyName"); // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–æ —Å—Ç—Ä–æ–∫–æ–≤–æ–º—É –∫–ª—é—á—É

  await store.batch(async () => {
    // –ù–∞—á–∞–ª–æ –±–∞—Ç—á–∞ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ)
    store.update(store.$.user.name, "QtPy"); // –ú–µ–Ω—è–µ–º –∏–º—è
    store.update(store.$.user.contacts.email, "my@emai.com"); // –ú–µ–Ω—è–µ–º email
    await store.asyncUpdate(
      store.$.user.age,
      async (
        cur // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —É–¥–≤–æ–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
      ) =>
        new Promise((resolve) =>
          setTimeout(() => {
            resolve(cur * 2);
          }, 2000)
        )
    );
    store.update(store.$.user.contacts.lol.value, 999999); // –ò–∑–º–µ–Ω—è–µ–º lol –∑–Ω–∞—á–µ–Ω–∏–µ
    store.update(store.$.counter, 2); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
  }); // –ö–æ–Ω–µ—Ü –±–∞—Ç—á–∞

  await store.undo(store.$.user.age); // –û—Ç–º–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞
  setTimeout(() => {
    store.undo(store.$.user.age); // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–º–µ–Ω–∞ —á–µ—Ä–µ–∑ 200 –º—Å
  }, 200);

  // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä—è–º–æ–≥–æ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ state-–ø—Ä–æ–∫—Å–∏
  store.state.counter += 23; // –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á—ë—Ç—á–∏–∫–∞ –Ω–∞–ø—Ä—è–º—É—é
  store.state.user.contacts.email = "233333333333"; // –ü—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ email
};
test();
```
